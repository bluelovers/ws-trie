"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const trie_1 = require("./trie");
class AhoCorasick {
    constructor() {
        this.trie = new trie_1.default();
    }
    add(word, data) {
        return this.trie.add(word, data);
    }
    build_fail(node) {
        let _k, fail_node, i, j, ref, ref1, sub_node;
        node = node || this.trie;
        node.fail = null;
        if (node.value) {
            for (i = j = 1, ref = node.value.length; (1 <= ref ? j < ref : j > ref); i = 1 <= ref ? ++j : --j) {
                fail_node = this.trie.explore_fail_link(node.value.substring(i));
                if (fail_node) {
                    node.fail = fail_node;
                    break;
                }
            }
        }
        ref1 = node.next;
        for (_k in ref1) {
            sub_node = ref1[_k];
            this.build_fail(sub_node);
        }
        return this;
    }
    foreach_match(node, pos, callback) {
        let offset;
        while (node) {
            if (node.is_word) {
                offset = pos - node.value.length;
                callback(node.value, node.data, offset, node);
            }
            node = node.fail;
        }
        return this;
    }
    search(string, callback) {
        /**
         * 參考 aca 回傳的資料結構
         * @see https://www.npmjs.com/package/aca
         */
        let result = {
            matches: {},
            positions: {},
            count: {},
            data: {},
        };
        let callbackResult;
        if (callback) {
            callbackResult = function (...argv) {
                let [value, data, offset, node] = argv;
                result.matches[value] = result.matches[value] || [];
                result.matches[value].push(offset);
                result.positions[offset] = result.positions[offset] || [];
                result.positions[offset].push(value);
                if (result.count[value] == null) {
                    result.count[value] = 0;
                }
                result.count[value]++;
                result.data[value] = node.data;
                // @ts-ignore
                callback.call(result, ...argv);
            };
        }
        else {
            callbackResult = function (...argv) {
                let [value, data, offset, node] = argv;
                result.matches[value] = result.matches[value] || [];
                result.matches[value].push(offset);
                result.positions[offset] = result.positions[offset] || [];
                result.positions[offset].push(value);
                if (result.count[value] == null) {
                    result.count[value] = 0;
                }
                result.count[value]++;
                result.data[value] = node.data;
            };
        }
        let chr, current, idx, j, ref;
        current = this.trie;
        for (idx = j = 0, ref = string.length; (0 <= ref ? j < ref : j > ref); idx = 0 <= ref ? ++j : --j) {
            chr = string.charAt(idx);
            while (current && !current.next[chr]) {
                current = current.fail;
            }
            if (!current) {
                current = this.trie;
            }
            if (current.next[chr]) {
                current = current.next[chr];
                this.foreach_match(current, idx + 1, callbackResult);
            }
        }
        // @ts-ignore
        return result;
    }
    to_dot() {
        let dot, fail_cb, last_chr, link_cb, v_;
        dot = ['digraph Trie {'];
        v_ = function (node) {
            if (node && node.value) {
                return `"${node.value}"`;
            }
            else {
                return "\"\"";
            }
        };
        last_chr = function (str) {
            if (str) {
                return str.charAt(str.length - 1);
            }
        };
        link_cb = function (from, to) {
            let k, option, to_label, to_opt, v;
            to_label = last_chr(to.value);
            to_opt = [`label = "${to_label}"`];
            if (to.is_word) {
                option = {
                    style: 'filled',
                    color: 'skyblue'
                };
                for (k in option) {
                    v = option[k];
                    to_opt.push(`${k} = "${v}"`);
                }
            }
            dot.push(`${v_(from)} -> ${v_(to)};`);
            dot.push(`${v_(to)} [ ${to_opt.join(',')} ];`);
            return fail_cb(from, to);
        };
        fail_cb = function (from, to) {
            let style;
            [from, to] = [to, to.fail];
            style = to ? 'dashed' : 'dotted';
            return dot.push(`${v_(from)} -> ${v_(to)} [ style = "${style}" ];`);
        };
        this.trie.each_node(link_cb);
        dot.push('}');
        return dot.join("\n");
    }
}
exports.AhoCorasick = AhoCorasick;
(function (AhoCorasick) {
})(AhoCorasick = exports.AhoCorasick || (exports.AhoCorasick = {}));
AhoCorasick.AhoCorasick = AhoCorasick;
AhoCorasick.Trie = trie_1.default;
exports.default = AhoCorasick;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWhvY29yYXNpY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhaG9jb3Jhc2ljay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUEwQjtBQVUxQixNQUFhLFdBQVc7SUFBeEI7UUFFQyxTQUFJLEdBQVksSUFBSSxjQUFJLEVBQUUsQ0FBQztJQW1NNUIsQ0FBQztJQWpNQSxHQUFHLENBQUMsSUFBWSxFQUFFLElBQVE7UUFFekIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFjO1FBRXhCLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDO1FBQzdDLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQ2Q7WUFDQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUNqRztnQkFDQyxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLFNBQVMsRUFDYjtvQkFDQyxJQUFJLENBQUMsSUFB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QkQsV0FBaUIsV0FBVztBQVM1QixDQUFDLEVBVGdCLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBUzNCO0FBRUQsV0FBVyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7QUFDdEMsV0FBVyxDQUFDLElBQUksR0FBRyxjQUFJLENBQUM7QUFFeEIsa0JBQWUsV0FBVyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFRyaWUgZnJvbSAnLi90cmllJztcblxuZGVjbGFyZSBtb2R1bGUgJy4vdHJpZSdcbntcblx0ZXhwb3J0IGludGVyZmFjZSBUcmllPFQ+XG5cdHtcblx0XHRmYWlsPzogVHJpZTxUPlxuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBBaG9Db3Jhc2ljazxUID0gYW55Plxue1xuXHR0cmllOiBUcmllPFQ+ID0gbmV3IFRyaWUoKTtcblxuXHRhZGQod29yZDogc3RyaW5nLCBkYXRhPzogVClcblx0e1xuXHRcdHJldHVybiB0aGlzLnRyaWUuYWRkKHdvcmQsIGRhdGEpO1xuXHR9XG5cblx0YnVpbGRfZmFpbChub2RlPzogVHJpZTxUPilcblx0e1xuXHRcdGxldCBfaywgZmFpbF9ub2RlLCBpLCBqLCByZWYsIHJlZjEsIHN1Yl9ub2RlO1xuXHRcdG5vZGUgPSBub2RlIHx8IHRoaXMudHJpZTtcblx0XHRub2RlLmZhaWwgPSBudWxsO1xuXHRcdGlmIChub2RlLnZhbHVlKVxuXHRcdHtcblx0XHRcdGZvciAoaSA9IGogPSAxLCByZWYgPSBub2RlLnZhbHVlLmxlbmd0aDsgKDEgPD0gcmVmID8gaiA8IHJlZiA6IGogPiByZWYpOyBpID0gMSA8PSByZWYgPyArK2ogOiAtLWopXG5cdFx0XHR7XG5cdFx0XHRcdGZhaWxfbm9kZSA9IHRoaXMudHJpZS5leHBsb3JlX2ZhaWxfbGluayhub2RlLnZhbHVlLnN1YnN0cmluZyhpKSk7XG5cdFx0XHRcdGlmIChmYWlsX25vZGUpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRub2RlLmZhaWwgPSBmYWlsX25vZGU7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdFx0cmVmMSA9IG5vZGUubmV4dDtcblx0XHRmb3IgKF9rIGluIHJlZjEpXG5cdFx0e1xuXHRcdFx0c3ViX25vZGUgPSByZWYxW19rXTtcblx0XHRcdHRoaXMuYnVpbGRfZmFpbChzdWJfbm9kZSk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0Zm9yZWFjaF9tYXRjaChub2RlOiBUcmllPFQ+LCBwb3M6IG51bWJlciwgY2FsbGJhY2s6IElBaG9Db3Jhc2lja0NhbGxiYWNrPFQ+KVxuXHR7XG5cdFx0bGV0IG9mZnNldDogbnVtYmVyO1xuXHRcdHdoaWxlIChub2RlKVxuXHRcdHtcblx0XHRcdGlmIChub2RlLmlzX3dvcmQpXG5cdFx0XHR7XG5cdFx0XHRcdG9mZnNldCA9IHBvcyAtIG5vZGUudmFsdWUubGVuZ3RoO1xuXHRcdFx0XHRjYWxsYmFjayhub2RlLnZhbHVlLCBub2RlLmRhdGEsIG9mZnNldCwgbm9kZSk7XG5cdFx0XHR9XG5cdFx0XHRub2RlID0gbm9kZS5mYWlsO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHNlYXJjaChzdHJpbmc6IHN0cmluZywgY2FsbGJhY2s/OiBJQWhvQ29yYXNpY2tDYWxsYmFjazxUPik6IElBaG9Db3Jhc2lja1Jlc3VsdDxUPlxuXHRzZWFyY2g8UiA9IElBaG9Db3Jhc2lja1Jlc3VsdDxUPj4oc3RyaW5nOiBzdHJpbmcsIGNhbGxiYWNrPzogSUFob0NvcmFzaWNrQ2FsbGJhY2s8VD4pOiBSXG5cdHNlYXJjaChzdHJpbmc6IHN0cmluZywgY2FsbGJhY2s/OiBJQWhvQ29yYXNpY2tDYWxsYmFjazxUPilcblx0e1xuXHRcdC8qKlxuXHRcdCAqIOWPg+iAgyBhY2Eg5Zue5YKz55qE6LOH5paZ57WQ5qeLXG5cdFx0ICogQHNlZSBodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS9hY2Fcblx0XHQgKi9cblx0XHRsZXQgcmVzdWx0OiBJQWhvQ29yYXNpY2tSZXN1bHQ8VD4gPSB7XG5cdFx0XHRtYXRjaGVzOiB7fSxcblx0XHRcdHBvc2l0aW9uczoge30sXG5cdFx0XHRjb3VudDoge30sXG5cdFx0XHRkYXRhOiB7fSxcblx0XHR9O1xuXG5cdFx0bGV0IGNhbGxiYWNrUmVzdWx0OiBJQWhvQ29yYXNpY2tDYWxsYmFjazxUPjtcblxuXHRcdGlmIChjYWxsYmFjaylcblx0XHR7XG5cdFx0XHRjYWxsYmFja1Jlc3VsdCA9IGZ1bmN0aW9uICguLi5hcmd2KVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgW3ZhbHVlLCBkYXRhLCBvZmZzZXQsIG5vZGVdID0gYXJndjtcblxuXHRcdFx0XHRyZXN1bHQubWF0Y2hlc1t2YWx1ZV0gPSByZXN1bHQubWF0Y2hlc1t2YWx1ZV0gfHwgW107XG5cblx0XHRcdFx0cmVzdWx0Lm1hdGNoZXNbdmFsdWVdLnB1c2gob2Zmc2V0KTtcblxuXHRcdFx0XHRyZXN1bHQucG9zaXRpb25zW29mZnNldF0gPSByZXN1bHQucG9zaXRpb25zW29mZnNldF0gfHwgW107XG5cdFx0XHRcdHJlc3VsdC5wb3NpdGlvbnNbb2Zmc2V0XS5wdXNoKHZhbHVlKTtcblxuXHRcdFx0XHRpZiAocmVzdWx0LmNvdW50W3ZhbHVlXSA9PSBudWxsKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmVzdWx0LmNvdW50W3ZhbHVlXSA9IDA7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXN1bHQuY291bnRbdmFsdWVdKys7XG5cblx0XHRcdFx0cmVzdWx0LmRhdGFbdmFsdWVdID0gbm9kZS5kYXRhO1xuXG5cdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0Y2FsbGJhY2suY2FsbChyZXN1bHQsIC4uLmFyZ3YpO1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdGNhbGxiYWNrUmVzdWx0ID0gZnVuY3Rpb24gKC4uLmFyZ3YpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBbdmFsdWUsIGRhdGEsIG9mZnNldCwgbm9kZV0gPSBhcmd2O1xuXG5cdFx0XHRcdHJlc3VsdC5tYXRjaGVzW3ZhbHVlXSA9IHJlc3VsdC5tYXRjaGVzW3ZhbHVlXSB8fCBbXTtcblxuXHRcdFx0XHRyZXN1bHQubWF0Y2hlc1t2YWx1ZV0ucHVzaChvZmZzZXQpO1xuXG5cdFx0XHRcdHJlc3VsdC5wb3NpdGlvbnNbb2Zmc2V0XSA9IHJlc3VsdC5wb3NpdGlvbnNbb2Zmc2V0XSB8fCBbXTtcblx0XHRcdFx0cmVzdWx0LnBvc2l0aW9uc1tvZmZzZXRdLnB1c2godmFsdWUpO1xuXG5cdFx0XHRcdGlmIChyZXN1bHQuY291bnRbdmFsdWVdID09IG51bGwpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXN1bHQuY291bnRbdmFsdWVdID0gMDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJlc3VsdC5jb3VudFt2YWx1ZV0rKztcblxuXHRcdFx0XHRyZXN1bHQuZGF0YVt2YWx1ZV0gPSBub2RlLmRhdGE7XG5cdFx0XHR9O1xuXHRcdH1cblxuXHRcdGxldCBjaHIsIGN1cnJlbnQsIGlkeCwgaiwgcmVmO1xuXHRcdGN1cnJlbnQgPSB0aGlzLnRyaWU7XG5cdFx0Zm9yIChpZHggPSBqID0gMCwgcmVmID0gc3RyaW5nLmxlbmd0aDsgKDAgPD0gcmVmID8gaiA8IHJlZiA6IGogPiByZWYpOyBpZHggPSAwIDw9IHJlZiA/ICsraiA6IC0tailcblx0XHR7XG5cdFx0XHRjaHIgPSBzdHJpbmcuY2hhckF0KGlkeCk7XG5cdFx0XHR3aGlsZSAoY3VycmVudCAmJiAhY3VycmVudC5uZXh0W2Nocl0pXG5cdFx0XHR7XG5cdFx0XHRcdGN1cnJlbnQgPSBjdXJyZW50LmZhaWw7XG5cdFx0XHR9XG5cdFx0XHRpZiAoIWN1cnJlbnQpXG5cdFx0XHR7XG5cdFx0XHRcdGN1cnJlbnQgPSB0aGlzLnRyaWU7XG5cdFx0XHR9XG5cdFx0XHRpZiAoY3VycmVudC5uZXh0W2Nocl0pXG5cdFx0XHR7XG5cdFx0XHRcdGN1cnJlbnQgPSBjdXJyZW50Lm5leHRbY2hyXTtcblxuXHRcdFx0XHR0aGlzLmZvcmVhY2hfbWF0Y2goY3VycmVudCwgaWR4ICsgMSwgY2FsbGJhY2tSZXN1bHQpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0dG9fZG90KCk6IHN0cmluZ1xuXHR7XG5cdFx0bGV0IGRvdCwgZmFpbF9jYiwgbGFzdF9jaHIsIGxpbmtfY2IsIHZfO1xuXHRcdGRvdCA9IFsnZGlncmFwaCBUcmllIHsnXTtcblx0XHR2XyA9IGZ1bmN0aW9uIChub2RlKVxuXHRcdHtcblx0XHRcdGlmIChub2RlICYmIG5vZGUudmFsdWUpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBgXCIke25vZGUudmFsdWV9XCJgO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gXCJcXFwiXFxcIlwiO1xuXHRcdFx0fVxuXHRcdH07XG5cdFx0bGFzdF9jaHIgPSBmdW5jdGlvbiAoc3RyKVxuXHRcdHtcblx0XHRcdGlmIChzdHIpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBzdHIuY2hhckF0KHN0ci5sZW5ndGggLSAxKTtcblx0XHRcdH1cblx0XHR9O1xuXHRcdGxpbmtfY2IgPSBmdW5jdGlvbiAoZnJvbSwgdG8pXG5cdFx0e1xuXHRcdFx0bGV0IGssIG9wdGlvbiwgdG9fbGFiZWwsIHRvX29wdCwgdjtcblx0XHRcdHRvX2xhYmVsID0gbGFzdF9jaHIodG8udmFsdWUpO1xuXHRcdFx0dG9fb3B0ID0gW2BsYWJlbCA9IFwiJHt0b19sYWJlbH1cImBdO1xuXHRcdFx0aWYgKHRvLmlzX3dvcmQpXG5cdFx0XHR7XG5cdFx0XHRcdG9wdGlvbiA9IHtcblx0XHRcdFx0XHRzdHlsZTogJ2ZpbGxlZCcsXG5cdFx0XHRcdFx0Y29sb3I6ICdza3libHVlJ1xuXHRcdFx0XHR9O1xuXHRcdFx0XHRmb3IgKGsgaW4gb3B0aW9uKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0diA9IG9wdGlvbltrXTtcblx0XHRcdFx0XHR0b19vcHQucHVzaChgJHtrfSA9IFwiJHt2fVwiYCk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGRvdC5wdXNoKGAke3ZfKGZyb20pfSAtPiAke3ZfKHRvKX07YCk7XG5cdFx0XHRkb3QucHVzaChgJHt2Xyh0byl9IFsgJHt0b19vcHQuam9pbignLCcpfSBdO2ApO1xuXHRcdFx0cmV0dXJuIGZhaWxfY2IoZnJvbSwgdG8pO1xuXHRcdH07XG5cdFx0ZmFpbF9jYiA9IGZ1bmN0aW9uIChmcm9tLCB0bylcblx0XHR7XG5cdFx0XHRsZXQgc3R5bGU7XG5cdFx0XHRbZnJvbSwgdG9dID0gW3RvLCB0by5mYWlsXTtcblx0XHRcdHN0eWxlID0gdG8gPyAnZGFzaGVkJyA6ICdkb3R0ZWQnO1xuXHRcdFx0cmV0dXJuIGRvdC5wdXNoKGAke3ZfKGZyb20pfSAtPiAke3ZfKHRvKX0gWyBzdHlsZSA9IFwiJHtzdHlsZX1cIiBdO2ApO1xuXHRcdH07XG5cdFx0dGhpcy50cmllLmVhY2hfbm9kZShsaW5rX2NiKTtcblx0XHRkb3QucHVzaCgnfScpO1xuXHRcdHJldHVybiBkb3Quam9pbihcIlxcblwiKTtcblx0fVxuXG59XG5cbmV4cG9ydCB0eXBlIElBaG9Db3Jhc2lja0NhbGxiYWNrPFQ+ID0gKHZhbHVlOiBzdHJpbmcsIGRhdGE6IFRbXSwgb2Zmc2V0OiBudW1iZXIsIG5vZGU6IFRyaWU8VD4pID0+IHZvaWRcblxuZXhwb3J0IHR5cGUgSUFob0NvcmFzaWNrUmVzdWx0PFQgPSBhbnk+ID0ge1xuXHQvKipcblx0ICoga2V5d29yZDogcG9zaXRpb25bXVxuXHQgKi9cblx0bWF0Y2hlczoge1xuXHRcdFtrOiBzdHJpbmddOiBudW1iZXJbXSxcblx0fSxcblx0LyoqXG5cdCAqIHBvc2l0aW9uOiBrZXl3b3JkW11cblx0ICovXG5cdHBvc2l0aW9uczoge1xuXHRcdFtrOiBudW1iZXJdOiBzdHJpbmdbXSxcblx0fSxcblx0LyoqXG5cdCAqIGtleXdvcmQ6IGNvdW50XG5cdCAqL1xuXHRjb3VudDoge1xuXHRcdFtrOiBzdHJpbmddOiBudW1iZXIsXG5cdH0sXG5cdC8qKlxuXHQgKiBrZXl3b3JkOiBkYXRhXG5cdCAqL1xuXHRkYXRhOiB7XG5cdFx0W2s6IHN0cmluZ106IFRbXSxcblx0fSxcbn07XG5cbmV4cG9ydCBuYW1lc3BhY2UgQWhvQ29yYXNpY2tcbntcblx0Ly8gQHRzLWlnbm9yZVxuXHRleHBvcnQgeyBJQWhvQ29yYXNpY2tDYWxsYmFjayB9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRleHBvcnQgeyBBaG9Db3Jhc2ljayB9XG5cdC8vIEB0cy1pZ25vcmVcblx0ZXhwb3J0IHsgVHJpZSB9XG59XG5cbkFob0NvcmFzaWNrLkFob0NvcmFzaWNrID0gQWhvQ29yYXNpY2s7XG5BaG9Db3Jhc2ljay5UcmllID0gVHJpZTtcblxuZXhwb3J0IGRlZmF1bHQgQWhvQ29yYXNpY2tcbiJdfQ==